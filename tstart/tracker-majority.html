<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Baccarat Data Collector v4.3 (Editable Hand #)</title> <style> * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f0f0f0;
        padding: 15px;
    }
    
    .main-container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 200px;
        gap: 15px;
    }
    
    .form-container {
        background: white;
        border: 1px solid #ccc;
        padding: 15px;
    }
    
    .sidebar {
        background: white;
        border: 1px solid #ccc;
        padding: 12px;
    }
    
    /* Ultra-compact metadata bar */
    .metadata-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 12px;
        font-size: 13px;
    }
    
    .metadata-bar label {
        font-weight: 600;
        color: #333;
        margin-right: 4px;
    }
    
    .metadata-bar input[type="radio"] {
        margin: 0 3px 0 8px;
    }
    
    .metadata-bar input[type="number"] {
        width: 50px;
        padding: 4px 6px;
        border: 1px solid #999;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        font-weight: bold;
    }
    
    .metadata-bar input[type="number"]:read-only {
        background: #f5f5f5;
        color: #666;
    }
    
    .metadata-bar input[type="number"]#dealerHandNumber {
        width: 60px;
    }
    
    .new-shoe-btn {
        padding: 5px 12px;
        background: #dc3545;
        color: white;
        border: none;
        font-size: 11px;
        font-weight: 700;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .new-shoe-btn:hover {
        background: #c82333;
    }
    
    /* tStart section */
    .tstart-section {
        background: #f8f9fa;
        border: 2px solid #495057;
        padding: 12px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 20px;
    }
    
    .tstart-section label {
        font-weight: 700;
        font-size: 13px;
        color: #000;
        font-family: 'Courier New', monospace;
    }
    
    #tStart {
        width: 120px;
        font-size: 36px;
        font-weight: bold;
        text-align: center;
        padding: 8px;
        border: 2px solid #000;
        background: white;
        font-family: 'Courier New', monospace;
    }
    
    /* Remove scroll arrows from number inputs */
    input[type="number"].no-scroll::-webkit-outer-spin-button,
    input[type="number"].no-scroll::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    input[type="number"].no-scroll {
        -moz-appearance: textfield;
    }
    
    .dealer-change-inline {
        display: flex;
        align-items: center;
        font-size: 12px;
        margin-left: auto;
    }
    
    .dealer-change-inline input {
        width: 16px;
        height: 16px;
        margin-right: 6px;
    }
    
    /* Betting grid - ultra compact */
    .betting-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 12px;
    }
    
    .betting-box {
        border: 2px solid;
        padding: 8px;
        background: white;
    }
    
    .betting-box.player { border-color: #0066cc; }
    .betting-box.tie { border-color: #28a745; }
    .betting-box.banker { border-color: #dc3545; }
    
    .betting-box-title {
        font-weight: 700;
        font-size: 11px;
        text-align: center;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .betting-box.player .betting-box-title { color: #0066cc; }
    .betting-box.tie .betting-box-title { color: #28a745; }
    .betting-box.banker .betting-box-title { color: #dc3545; }
    
    .betting-box input {
        width: 100%;
        padding: 4px 6px;
        margin-bottom: 4px;
        border: 1px solid #999;
        font-size: 13px;
        font-family: 'Courier New', monospace;
    }
    
    .betting-box label {
        font-size: 10px;
        color: #666;
        font-weight: 600;
    }
    
    /* Pair buttons - positioned above scores */
    .pair-buttons-section {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }
    
    .pair-button {
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 700;
        border: 2px solid #999;
        background: #f8f9fa;
        cursor: pointer;
        user-select: none;
        color: #333;
    }
    
    .pair-button.player-pair.active {
        background: #0066cc;
        border-color: #0066cc;
        color: white;
    }
    
    .pair-button.banker-pair.active {
        background: #dc3545;
        border-color: #dc3545;
        color: white;
    }
    
    .pair-button.player-pp.active {
        background: #003d7a;
        border-color: #003d7a;
        color: white;
    }
    
    .pair-button.banker-pp.active {
        background: #8b0000;
        border-color: #8b0000;
        color: white;
    }
    
    .pair-button:hover {
        background: #e9ecef;
    }
    
    .pair-button.active:hover {
        opacity: 0.9;
    }
    
    /* Scores section */
    .scores-section {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
        padding: 10px;
        background: #f8f9fa;
        border: 1px solid #ccc;
    }
    
    .score-input-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .score-input-group label {
        font-weight: 700;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .score-input-group.player label { color: #0066cc; }
    .score-input-group.banker label { color: #dc3545; }
    
    .score-input-group input {
        width: 100%;
        padding: 8px;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        border: 2px solid #999;
        font-family: 'Courier New', monospace;
    }
    
    .score-input-group.player input { border-color: #0066cc; }
    .score-input-group.banker input { border-color: #dc3545; }
    
    /* Green border for tie scores */
    .score-input-group.player input.tie-detected { border-color: #28a745 !important; }
    .score-input-group.banker input.tie-detected { border-color: #28a745 !important; }
    
    .vs-divider {
        font-size: 24px;
        font-weight: bold;
        color: #999;
    }
    
    /* Natural button - full width */
    .natural-button-section {
        margin-bottom: 12px;
    }
    
    .natural-button {
        width: 100%;
        padding: 12px;
        font-size: 14px;
        font-weight: 700;
        border: 2px solid #999;
        background: #f8f9fa;
        cursor: pointer;
        user-select: none;
        color: #333;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .natural-button.active {
        background: #28a745;
        border-color: #28a745;
        color: white;
    }
    
    .natural-button:hover {
        background: #e9ecef;
    }
    
    .natural-button.active:hover {
        background: #218838;
    }
    
    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .action-button {
        flex: 1;
        padding: 12px;
        font-size: 14px;
        font-weight: 700;
        border: none;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .action-button.primary {
        background: #28a745;
        color: white;
    }
    
    .action-button.primary:hover {
        background: #218838;
    }
    
    .action-button.secondary {
        background: #6c757d;
        color: white;
    }
    
    .action-button.secondary:hover {
        background: #5a6268;
    }
    
    /* Certification message */
    .certification-message {
        padding: 12px;
        margin-top: 10px;
        background: #fff3cd;
        border: 2px solid #ffc107;
        color: #856404;
        font-size: 13px;
        font-weight: 600;
        display: none;
    }
    
    /* Validation message */
    .validation-message {
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 600;
        display: none;
    }
    
    .validation-message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .validation-message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    /* Sidebar styling */
    .sidebar h3 {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #666;
        margin-bottom: 8px;
        padding-bottom: 4px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .sidebar-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 12px;
    }
    
    .sidebar-label {
        color: #666;
        font-weight: 600;
    }
    
    .sidebar-value {
        font-weight: 700;
        color: #000;
        font-family: 'Courier New', monospace;
    }
    
    .sidebar-section {
        margin-bottom: 15px;
    }
    
    .export-button {
        width: 100%;
        padding: 8px;
        background: #007bff;
        color: white;
        border: none;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }
    
    .export-button:hover {
        background: #0056b3;
    }
    
    .skip-button {
        width: 100%;
        padding: 8px;
        background: #ffc107;
        color: #000;
        border: none;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }
    
    .skip-button:hover {
        background: #e0a800;
    }
    
    .clear-button {
        width: 100%;
        padding: 8px;
        background: #dc3545;
        color: white;
        border: none;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .clear-button:hover {
        background: #c82333;
    }
    
    /* Recent hands */
    .recent-hands-container {
        max-height: 250px;
        overflow-y: auto;
    }
    
    .recent-hand {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 8px;
        margin-bottom: 6px;
        cursor: pointer;
        font-size: 11px;
    }
    
    .recent-hand:hover {
        background: #e9ecef;
    }
    
    .recent-hand-header {
        font-weight: 700;
        margin-bottom: 3px;
        color: #495057;
    }
    
    .recent-hand-details {
        color: #6c757d;
        font-family: 'Courier New', monospace;
    }
    
    /* Modal styling */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 30px auto;
        padding: 20px;
        border: 1px solid #888;
        width: 700px;
        max-height: 90vh;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
    }
    
    .modal-header h2 {
        font-size: 16px;
        margin: 0;
    }
    
    .modal-close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #999;
    }
    
    .modal-close:hover {
        color: #000;
    }
    
    /* Redesigned edit modal layout */
    .edit-tstart-section {
        margin-bottom: 15px;
    }
    
    .edit-tstart-section label {
        display: block;
        font-size: 11px;
        font-weight: 600;
        color: #666;
        margin-bottom: 4px;
    }
    
    .edit-tstart-section input {
        width: 150px;
        padding: 8px;
        border: 1px solid #999;
        font-size: 16px;
        font-family: 'Courier New', monospace;
        font-weight: bold;
    }
    
    .edit-betting-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .edit-betting-field {
        display: flex;
        flex-direction: column;
    }
    
    .edit-betting-field label {
        font-size: 10px;
        font-weight: 600;
        color: #666;
        margin-bottom: 3px;
    }
    
    .edit-betting-field input {
        padding: 6px;
        border: 1px solid #999;
        font-size: 13px;
        font-family: 'Courier New', monospace;
    }
    
    .edit-scores-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .edit-score-field {
        display: flex;
        flex-direction: column;
    }
    
    .edit-score-field label {
        font-size: 11px;
        font-weight: 600;
        color: #666;
        margin-bottom: 3px;
    }
    
    .edit-score-field input {
        padding: 8px;
        border: 2px solid #999;
        font-size: 18px;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        text-align: center;
    }
    
    .edit-checkboxes-section {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .edit-checkbox-field {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .edit-checkbox-field input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }
    
    .edit-checkbox-field label {
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
    }
    
    .modal-preview {
        background: #f8f9fa;
        padding: 10px;
        border: 1px solid #dee2e6;
        font-size: 12px;
        font-family: 'Courier New', monospace;
        margin-bottom: 15px;
    }
    
    .modal-preview-row {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
    }
    
    .modal-buttons {
        display: flex;
        gap: 10px;
    }
    
    .modal-button {
        flex: 1;
        padding: 10px;
        font-size: 13px;
        font-weight: 700;
        border: none;
        cursor: pointer;
        text-transform: uppercase;
    }
    
    /* Clear All Modal */
    .clear-all-modal .modal-content {
        width: 400px;
    }
    
    .clear-all-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        padding: 15px;
        margin-bottom: 15px;
        font-size: 14px;
        font-weight: 600;
        color: #856404;
    }
    
    .clear-all-confirmation {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        margin-bottom: 15px;
    }
    
    .clear-all-confirmation input[type="checkbox"] {
        width: 20px;
        height: 20px;
    }
    
    .clear-all-confirmation label {
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
    }
</style>
</head> <body> <div class="main-container"> <!-- MAIN FORM --> <div class="form-container"> <!-- Metadata Bar --> <div class="metadata-bar"> <label>State:</label> <input type="radio" name="state" value="NJ" id="stateNJ" checked> <label for="stateNJ">NJ</label> <input type="radio" name="state" value="PA" id="statePA"> <label for="statePA">PA</label>
            <span style="margin: 0 8px; color: #ccc;">|</span>
            
            <label>Shoe:</label>
            <input type="number" id="shoeNumber" value="1" readonly>
            
            <label>Hand:</label>
            <!-- MODIFICATION: Removed readonly, added onkeypress and oninput handlers -->
            <input type="number" id="handNumber" value="1" 
                   onkeypress="return preventDecimal(event)" 
                   oninput="enforceInteger(this); handleHandNumberChange(this)">
            
            <label>Dealer #:</label>
            <input type="number" id="dealerHandNumber" placeholder="NULL" min="1" 
                   onkeypress="return preventDecimal(event)" 
                   oninput="enforceInteger(this)">
            
            <button class="new-shoe-btn" onclick="startNewShoe()">New Shoe</button>
        </div>
        
        <!-- tStart Section -->
        <div class="tstart-section">
            <label>tStart:</label>
            <input type="number" class="no-scroll" id="tStart" step="1" min="0" placeholder="0" inputmode="numeric"
                   onkeypress="return preventDecimal(event)" 
                   oninput="enforceInteger(this)">
            
            <div class="dealer-change-inline">
                <input type="checkbox" id="dealerChange" onchange="handleDealerChange()" tabindex="100">
                <label for="dealerChange">Dealer Change</label>
            </div>
        </div>
        
        <!-- Betting Grid -->
        <div class="betting-grid">
            <!-- Player -->
            <div class="betting-box player">
                <div class="betting-box-title">Player</div>
                <label>$ Bet:</label>
                <input type="number" id="usdPlayer" step="0.01" min="0" placeholder="0" inputmode="decimal">
                <label># Bets:</label>
                <input type="number" id="nPlayer" min="0" placeholder="0" inputmode="numeric"
                       onkeypress="return preventDecimal(event)" 
                       oninput="enforceInteger(this)">
            </div>
            
            <!-- Tie -->
            <div class="betting-box tie">
                <div class="betting-box-title">Tie</div>
                <label>$ Bet:</label>
                <input type="number" id="usdTie" step="0.01" min="0" placeholder="0" inputmode="decimal">
                <label># Bets:</label>
                <input type="number" id="nTie" min="0" placeholder="0" inputmode="numeric"
                       onkeypress="return preventDecimal(event)" 
                       oninput="enforceInteger(this)">
            </div>
            
            <!-- Banker -->
            <div class="betting-box banker">
                <div class="betting-box-title">Banker</div>
                <label>$ Bet:</label>
                <input type="number" id="usdBanker" step="0.01" min="0" placeholder="0" inputmode="decimal">
                <label># Bets:</label>
                <input type="number" id="nBanker" min="0" placeholder="0" inputmode="numeric"
                       onkeypress="return preventDecimal(event)" 
                       oninput="enforceInteger(this)">
            </div>
        </div>
        
        <!-- Pair Buttons (Above Scores) -->
        <div class="pair-buttons-section">
            <div class="pair-button player-pair" id="playerPairBtn" onclick="togglePlayerPair()">
                Player Pair (P)
            </div>
            <div class="pair-button player-pp" id="playerPPBtn" onclick="togglePlayerPP()" style="display: none;">
                Player PP
            </div>
            <div class="pair-button banker-pair" id="bankerPairBtn" onclick="toggleBankerPair()">
                Banker Pair (B)
            </div>
            <div class="pair-button banker-pp" id="bankerPPBtn" onclick="toggleBankerPP()" style="display: none;">
                Banker PP
            </div>
        </div>
        
        <!-- Scores Section -->
        <div class="scores-section">
            <div class="score-input-group player">
                <label>Player Score</label>
                <input type="number" class="no-scroll" id="playerScore" min="0" max="9" placeholder="0" inputmode="numeric"
                       onkeypress="return preventDecimal(event)" 
                       oninput="enforceInteger(this)">
            </div>
            
            <div class="vs-divider">VS</div>
            
            <div class="score-input-group banker">
                <label>Banker Score</label>
                <input type="number" class="no-scroll" id="bankerScore" min="0" max="9" placeholder="0" inputmode="numeric"
                       onkeypress="return preventDecimal(event)" 
                       oninput="enforceInteger(this)">
            </div>
        </div>
        
        <!-- Natural Button (Full Width) -->
        <div class="natural-button-section">
            <div class="natural-button" id="naturalBtn" onclick="toggleNatural()">
                Natural (N)
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="action-button primary" onclick="recordHand()">‚úì Record Hand</button>
        </div>
        
        <!-- Certification Message -->
        <div class="certification-message" id="certificationMessage">
            ‚ö†Ô∏è <strong>Confirm Non-Natural:</strong> Score contains 8 or 9 with margin ‚â•6. Press button again or Shift+Enter to certify this hand was NOT natural.
        </div>
        
        <!-- Validation Message -->
        <div class="validation-message" id="validationMessage"></div>
    </div>
    
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-section">
            <h3>Current Status</h3>
            <div class="sidebar-row">
                <span class="sidebar-label">State:</span>
                <span class="sidebar-value" id="sidebarState">NJ</span>
            </div>
            <div class="sidebar-row">
                <span class="sidebar-label">Shoe:</span>
                <span class="sidebar-value" id="sidebarShoe">1</span>
            </div>
            <div class="sidebar-row">
                <span class="sidebar-label">Hand:</span>
                <span class="sidebar-value" id="sidebarHand">1</span>
            </div>
            <div class="sidebar-row">
                <span class="sidebar-label">Total:</span>
                <span class="sidebar-value" id="sidebarTotal">0</span>
            </div>
            <div class="sidebar-row">
                <span class="sidebar-label">This Shoe:</span>
                <span class="sidebar-value" id="sidebarShoeCount">0</span>
            </div>
        </div>
        
        <div class="sidebar-section">
            <h3>Recent Hands</h3>
            <div class="recent-hands-container" id="recentHandsContainer">
                <p style="font-size: 11px; color: #999;">None</p>
            </div>
        </div>
        
        <div class="sidebar-section">
            <button class="export-button" onclick="exportCSV()">‚¨á Export CSV</button>
            <button class="export-button" onclick="exportJSON()">‚¨á Export JSON</button>
            <button class="skip-button" onclick="skipHand()">‚§≠ Skip Hand</button>
            <button class="clear-button" onclick="openClearAllModal()">üóë Clear All Data</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="editModalTitle">Edit Hand</h2>
            <span class="modal-close" onclick="closeEditModal()">&times;</span>
        </div>
        
        <!-- tStart at top by itself -->
        <div class="edit-tstart-section">
            <label>tStart</label>
            <input type="number" class="no-scroll" id="edit_tStart" step="1"
                   onkeypress="return preventDecimal(event)" 
                   oninput="enforceInteger(this)">
        </div>
        
        <!-- 3x2 betting grid -->
        <div class="edit-betting-grid">
            <div class="edit-betting-field">
                <label>Player $</label>
                <input type="number" id="edit_usdPlayer" step="0.01">
            </div>
            <div class="edit-betting-field">
                <label>Tie $</label>
                <input type="number" id="edit_usdTie" step="0.01">
            </div>
            <div class="edit-betting-field">
                <label>Banker $</label>
                <input type="number" id="edit_usdBanker" step="0.01">
            </div>
            <div class="edit-betting-field">
                <label>Player #</label>
                <input type="number" id="edit_nPlayer"
                       onkeypress="return preventDecimal(event)" 
                       oninput="enforceInteger(this)">
            </div>
            <div class="edit-betting-field">
                <label>Tie #</label>
                <input type="number" id="edit_nTie"
                       onkeypress="return preventDecimal(event)" 
                       oninput="enforceInteger(this)">
            </div>
            <div class="edit-betting-field">
                <label>Banker #</label>
                <input type="number" id="edit_nBanker"
                       onkeypress="return preventDecimal(event)" 
                       oninput="enforceInteger(this)">
            </div>
        </div>
        
        <!-- Scores -->
        <div class="edit-scores-section">
            <div class="edit-score-field">
                <label>Player Score</label>
                <input type="number" class="no-scroll" id="edit_playerScore" min="0" max="9"
                       onkeypress="return preventDecimal(event)" 
                       oninput="enforceInteger(this)">
            </div>
            <div class="edit-score-field">
                <label>Banker Score</label>
                <input type="number" class="no-scroll" id="edit_bankerScore" min="0" max="9"
                       onkeypress="return preventDecimal(event)" 
                       oninput="enforceInteger(this)">
            </div>
        </div>
        
        <!-- Checkboxes in compact horizontal layout -->
        <div class="edit-checkboxes-section">
            <div class="edit-checkbox-field">
                <input type="checkbox" id="edit_naturalWin">
                <label for="edit_naturalWin">Natural Win</label>
            </div>
            <div class="edit-checkbox-field">
                <input type="checkbox" id="edit_playerPair">
                <label for="edit_playerPair">Player Pair</label>
            </div>
            <div class="edit-checkbox-field">
                <input type="checkbox" id="edit_bankerPair">
                <label for="edit_bankerPair">Banker Pair</label>
            </div>
            <div class="edit-checkbox-field">
                <input type="checkbox" id="edit_playerPerfectPair">
                <label for="edit_playerPerfectPair">Player PP</label>
            </div>
            <div class="edit-checkbox-field">
                <input type="checkbox" id="edit_bankerPerfectPair">
                <label for="edit_bankerPerfectPair">Banker PP</label>
            </div>
        </div>
        
        <!-- Preview -->
        <div class="modal-preview">
            <div class="modal-preview-row">
                <span>Winner:</span>
                <span id="edit_preview_winner">-</span>
            </div>
            <div class="modal-preview-row">
                <span>Majority $ Correct:</span>
                <span id="edit_preview_majority">-</span>
            </div>
            <div class="modal-preview-row">
                <span>Bonus Payout:</span>
                <span id="edit_preview_bonus">-</span>
            </div>
        </div>
        
        <!-- Buttons -->
        <div class="modal-buttons">
            <button class="modal-button" style="background: #28a745; color: white;" onclick="saveEdit()">Save Changes</button>
            <button class="modal-button" style="background: #dc3545; color: white;" onclick="deleteHand()">Delete Hand</button>
            <button class="modal-button" style="background: #6c757d; color: white;" onclick="closeEditModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Clear All Data Modal -->
<div id="clearAllModal" class="modal clear-all-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚ö†Ô∏è Clear All Data</h2>
            <span class="modal-close" onclick="closeClearAllModal()">&times;</span>
        </div>
        
        <div class="clear-all-warning">
            This will permanently delete all collected hands. This action cannot be undone!
        </div>
        
        <div class="clear-all-confirmation">
            <input type="checkbox" id="clearAllConfirmCheck">
            <label for="clearAllConfirmCheck">I understand this will delete all data permanently</label>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-button" style="background: #dc3545; color: white;" onclick="confirmClearAll()">Yes, Delete All Data</button>
            <button class="modal-button" style="background: #6c757d; color: white;" onclick="closeClearAllModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Generic Confirmation Modal -->
<div id="confirmModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 400px; max-height: 80vh;">
        <div class="modal-header">
            <h2 id="confirmModalTitle">Are you sure?</h2>
            <span class="modal-close" onclick="closeConfirmModal()">&times;</span>
        </div>
        <div id="confirmModalBody" style="padding: 20px 0; font-size: 14px; line-height: 1.5;">
            This action cannot be undone.
        </div>
        <div class="modal-buttons">
            <button id="confirmModalYesBtn" class="modal-button" style="background: #dc3545; color: white;">Yes, Proceed</button>
            <button class="modal-button" style="background: #6c757d; color: white;" onclick="closeConfirmModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    // ============================================
    // INTEGER ENFORCEMENT FUNCTIONS
    // ============================================
    function preventDecimal(event) {
        // Prevent period/decimal point entry
        if (event.key === '.' || event.key === ',') {
            event.preventDefault();
            return false;
        }
        return true;
    }
    
    function enforceInteger(input) {
        // Strip any decimal points that get through
        if (input.value.includes('.')) {
            input.value = input.value.replace(/\./g, '');
        }
        if (input.value.includes(',')) {
            input.value = input.value.replace(/,/g, '');
        }
    }
    
    // ============================================
    // STATE MANAGEMENT
    // ============================================
    let dataCollection = [];
    let currentShoeNumber = 1;
    let currentHandNumber = 1;
    let currentDealerHandNumber = null;
    let handsInCurrentShoe = 0;
    let currentEditingIndex = null;
    
    // Toggle button states
    let playerPairState = false;
    let bankerPairState = false;
    let playerPerfectPairState = false;
    let bankerPerfectPairState = false;
    let naturalWinState = false;
    
    // Certification state
    let awaitingNonNaturalCert = false;
    
    // ============================================
    // INITIALIZATION
    // ============================================
    window.onload = function() {
        loadFromStorage();
        updateSidebar();
        updateRecentHandsBubbles();
        
        // State change handlers
        document.querySelectorAll('input[name="state"]').forEach(radio => {
            radio.addEventListener('change', updateSidebar);
        });
        
        // Tie detection for main form
        document.getElementById('playerScore').addEventListener('input', detectTieMain);
        document.getElementById('bankerScore').addEventListener('input', detectTieMain);
        
        // Global keyboard shortcuts for P, B, N and Shift+Enter
        document.addEventListener('keydown', function(e) {
            // Only handle shortcuts if modal is not open
            const modalOpen = document.getElementById('editModal').style.display === 'block' ||
                             document.getElementById('clearAllModal').style.display === 'block';
            
            if (!modalOpen) {
                // Shift+Enter to submit
                if (e.key === 'Enter' && e.shiftKey) {
                    e.preventDefault();
                    recordHand();
                    return;
                }
                
                // P, B, N shortcuts even in input fields (since all inputs are numeric only)
                if (e.key.toLowerCase() === 'p') {
                    e.preventDefault();
                    togglePlayerPair();
                } else if (e.key.toLowerCase() === 'b') {
                    e.preventDefault();
                    toggleBankerPair();
                } else if (e.key.toLowerCase() === 'n') {
                    e.preventDefault();
                    toggleNatural();
                }
            }
        });
        
        // Edit modal Shift+Enter handler
        document.getElementById('editModal').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.shiftKey) {
                e.preventDefault();
                e.stopPropagation();
                saveEdit();
            }
        });
    };
    
    // ============================================
    // TIE DETECTION
    // ============================================
    function detectTieMain() {
        const playerScore = document.getElementById('playerScore').value;
        const bankerScore = document.getElementById('bankerScore').value;
        
        const playerInput = document.getElementById('playerScore');
        const bankerInput = document.getElementById('bankerScore');
        
        // Only apply tie styling if both have values and they're equal
        if (playerScore !== '' && bankerScore !== '' && playerScore === bankerScore) {
            playerInput.classList.add('tie-detected');
            bankerInput.classList.add('tie-detected');
        } else {
            playerInput.classList.remove('tie-detected');
            bankerInput.classList.remove('tie-detected');
        }
    }
    
    // ============================================
    // PAIR & NATURAL BUTTON LOGIC
    // ============================================
    function togglePlayerPair() {
        playerPairState = !playerPairState;
        document.getElementById('playerPairBtn').classList.toggle('active', playerPairState);
        
        // Show/hide Player PP button
        document.getElementById('playerPPBtn').style.display = playerPairState ? 'block' : 'none';
        
        // Reset perfect pair if pair is turned off
        if (!playerPairState) {
            playerPerfectPairState = false;
            document.getElementById('playerPPBtn').classList.remove('active');
        }
    }
    
    function toggleBankerPair() {
        bankerPairState = !bankerPairState;
        document.getElementById('bankerPairBtn').classList.toggle('active', bankerPairState);
        
        // Show/hide Banker PP button
        document.getElementById('bankerPPBtn').style.display = bankerPairState ? 'block' : 'none';
        
        // Reset perfect pair if pair is turned off
        if (!bankerPairState) {
            bankerPerfectPairState = false;
            document.getElementById('bankerPPBtn').classList.remove('active');
        }
    }
    
    function togglePlayerPP() {
        playerPerfectPairState = !playerPerfectPairState;
        document.getElementById('playerPPBtn').classList.toggle('active', playerPerfectPairState);
    }
    
    function toggleBankerPP() {
        bankerPerfectPairState = !bankerPerfectPairState;
        document.getElementById('bankerPPBtn').classList.toggle('active', bankerPerfectPairState);
    }
    
    function toggleNatural() {
        naturalWinState = !naturalWinState;
        document.getElementById('naturalBtn').classList.toggle('active', naturalWinState);
    }
    
    // ============================================
    // NON-NATURAL CERTIFICATION LOGIC
    // ============================================
    function requiresNonNaturalCert() {
        const playerScore = parseInt(document.getElementById('playerScore').value);
        const bankerScore = parseInt(document.getElementById('bankerScore').value);
        const natural = naturalWinState;
        
        // Check if validation would pass first
        if (isNaN(playerScore) || isNaN(bankerScore)) {
            return false;
        }
        
        // Certification condition: (8 or 9 present) AND (margin >= 6) AND (natural unchecked)
        const has8or9 = playerScore === 8 || playerScore === 9 || bankerScore === 8 || bankerScore === 9;
        const margin = Math.abs(playerScore - bankerScore);
        
        return has8or9 && margin >= 6 && !natural;
    }
    
    // ============================================
    // DERIVED METRICS COMPUTATION
    // ============================================
    function computeDerivedMetrics(data) {
        const winner = data.player_score > data.banker_score ? 'player' : 
                      data.player_score < data.banker_score ? 'banker' : 'tie';
        
        const majority_usd = data.usd_player > data.usd_banker && data.usd_player > data.usd_tie ? 'player' :
                            data.usd_banker > data.usd_player && data.usd_banker > data.usd_tie ? 'banker' :
                            data.usd_tie > data.usd_player && data.usd_tie > data.usd_banker ? 'tie' : 'none';
        
        const majority_count = data.n_player > data.n_banker && data.n_player > data.n_tie ? 'player' :
                              data.n_banker > data.n_player && data.n_banker > data.n_tie ? 'banker' :
                              data.n_tie > data.n_player && data.n_tie > data.n_banker ? 'tie' : 'none';
        
        const majority_usd_correct = (majority_usd === winner) ? 1 : 0;
        const majority_count_correct = (majority_count === winner) ? 1 : 0;
        
        let bonus_bet_payout = 0;
        if (data.natural_win) {
            if (winner === 'player') bonus_bet_payout = 5;
            else if (winner === 'banker') bonus_bet_payout = 5;
        } else {
            const margin = Math.abs(data.player_score - data.banker_score);
            if (winner === 'player' && margin === 4) bonus_bet_payout = 2;
            else if (winner === 'banker' && margin === 4) bonus_bet_payout = 2;
            else if (winner === 'banker' && margin === 5) bonus_bet_payout = 5;
            else if (winner === 'banker' && margin === 6) bonus_bet_payout = 10;
        }
        
        return {
            winner,
            majority_usd,
            majority_count,
            majority_usd_correct,
            majority_count_correct,
            bonus_bet_payout
        };
    }
    
    // ============================================
    // VALIDATION
    // ============================================
    function validateForm() {
        const tStart = parseFloat(document.getElementById('tStart').value);
        const playerScore = parseInt(document.getElementById('playerScore').value);
        const bankerScore = parseInt(document.getElementById('bankerScore').value);
        
        if (isNaN(tStart) || tStart < 0) {
            return 'tStart is required and must be ‚â• 0';
        }
        
        if (isNaN(playerScore) || playerScore < 0 || playerScore > 9) {
            return 'Player score must be 0-9';
        }
        
        if (isNaN(bankerScore) || bankerScore < 0 || bankerScore > 9) {
            return 'Banker score must be 0-9';
        }
        
        return null;
    }
    
    function showValidationMessage(message, type) {
        const msgDiv = document.getElementById('validationMessage');
        msgDiv.textContent = message;
        msgDiv.className = 'validation-message ' + type;
        msgDiv.style.display = 'block';
        
        setTimeout(() => {
            msgDiv.style.display = 'none';
        }, 3000);
    }
    
    function showCertificationMessage() {
        document.getElementById('certificationMessage').style.display = 'block';
    }
    
    function hideCertificationMessage() {
        document.getElementById('certificationMessage').style.display = 'none';
    }
    
    // ============================================
    // RECORD HAND
    // ============================================
    function recordHand() {
        const validationError = validateForm();
        if (validationError) {
            showValidationMessage(validationError, 'error');
            return;
        }
        
        // Check if non-natural certification is required
        if (requiresNonNaturalCert() && !awaitingNonNaturalCert) {
            // First submission - require certification
            awaitingNonNaturalCert = true;
            showCertificationMessage();
            return;
        }
        
        // If we reach here, either no cert needed or cert has been confirmed
        hideCertificationMessage();
        awaitingNonNaturalCert = false;
        
        const selectedState = document.querySelector('input[name="state"]:checked').value;
        
        // Ensure currentHandNumber is up-to-date from input just in case
        const handInputVal = parseInt(document.getElementById('handNumber').value);
        if (!isNaN(handInputVal) && handInputVal >= 1) {
            currentHandNumber = handInputVal;
        } else if (isNaN(currentHandNumber) || currentHandNumber < 1) {
            // Fallback if state variable is somehow corrupt
            currentHandNumber = 1; 
        }

        // --- BEGIN NEW DUPLICATE CHECK ---
        const existingHandIndex = dataCollection.findIndex(
            h => h.shoe_number === currentShoeNumber && h.hand_number === currentHandNumber
        );

        if (existingHandIndex > -1) {
            showValidationMessage(
                `Hand #${currentHandNumber} already exists. To edit, use the 'Recent Hands' list.`, 
                'error'
            );
            return;
        }
        // --- END NEW DUPLICATE CHECK ---
        
        const data = {
            state: selectedState,
            shoe_number: currentShoeNumber,
            hand_number: currentHandNumber, // Use the state variable
            dealer_hand_number: document.getElementById('dealerHandNumber').value || null,
            dealer_change: document.getElementById('dealerChange').checked,
            tStart: parseInt(document.getElementById('tStart').value),
            usd_player: parseFloat(document.getElementById('usdPlayer').value) || 0,
            usd_banker: parseFloat(document.getElementById('usdBanker').value) || 0,
            usd_tie: parseFloat(document.getElementById('usdTie').value) || 0,
            n_player: parseInt(document.getElementById('nPlayer').value) || 0,
            n_banker: parseInt(document.getElementById('nBanker').value) || 0,
            n_tie: parseInt(document.getElementById('nTie').value) || 0,
            player_score: parseInt(document.getElementById('playerScore').value),
            banker_score: parseInt(document.getElementById('bankerScore').value),
            player_pair: playerPairState,
            banker_pair: bankerPairState,
            player_perfect_pair: playerPerfectPairState,
            banker_perfect_pair: bankerPerfectPairState,
            natural_win: naturalWinState,
            timestamp: new Date().toISOString()
        };
        
        const computed = computeDerivedMetrics(data);
        const fullRecord = {...data, ...computed};
        
        dataCollection.push(fullRecord);
        saveToStorage();
        
        currentHandNumber++; // Increment for the *next* hand
        if (data.dealer_change) {
            currentDealerHandNumber = 1;
        } else if (currentDealerHandNumber !== null) {
            currentDealerHandNumber++;
        }
        
        handsInCurrentShoe++;
        
        clearForm();
        
        // Set input to the *next* hand number
        document.getElementById('handNumber').value = currentHandNumber;
        if (currentDealerHandNumber !== null) {
            document.getElementById('dealerHandNumber').value = currentDealerHandNumber;
        }
        
        updateSidebar();
        updateRecentHandsBubbles();
        
        showValidationMessage('Hand recorded successfully', 'success');
        
        // Auto-focus tStart field for next entry
        document.getElementById('tStart').focus();
    }
    
    // ============================================
    // SKIP HAND
    // ============================================
    function skipHand() {
        const handInputVal = parseInt(document.getElementById('handNumber').value) || currentHandNumber;
        
        openConfirmModal(
            'Skip Hand?',
            `Are you sure you want to skip Hand #${handInputVal}? The hand number will increment to #${handInputVal + 1}.`,
            'Yes, Skip',
            () => {
                // Ensure currentHandNumber is up-to-date from input
                if (!isNaN(handInputVal) && handInputVal >= 1) {
                    currentHandNumber = handInputVal;
                }
                
                currentHandNumber++;
                document.getElementById('handNumber').value = currentHandNumber;
                
                clearForm();
                updateSidebar();
                
                showValidationMessage('Hand #' + (currentHandNumber - 1) + ' skipped', 'error');
            }
        );
    }
    
    // ============================================
    // CLEAR FORM
    // ============================================
    function clearForm() {
        document.getElementById('tStart').value = '';
        document.getElementById('dealerChange').checked = false;
        document.getElementById('usdPlayer').value = '';
        document.getElementById('usdBanker').value = '';
        document.getElementById('usdTie').value = '';
        document.getElementById('nPlayer').value = '';
        document.getElementById('nBanker').value = '';
        document.getElementById('nTie').value = '';
        document.getElementById('playerScore').value = '';
        document.getElementById('bankerScore').value = '';
        
        playerPairState = false;
        bankerPairState = false;
        playerPerfectPairState = false;
        bankerPerfectPairState = false;
        naturalWinState = false;
        
        document.getElementById('playerPairBtn').classList.remove('active');
        document.getElementById('bankerPairBtn').classList.remove('active');
        document.getElementById('playerPPBtn').classList.remove('active');
        document.getElementById('bankerPPBtn').classList.remove('active');
        document.getElementById('playerPPBtn').style.display = 'none';
        document.getElementById('bankerPPBtn').style.display = 'none';
        document.getElementById('naturalBtn').classList.remove('active');
        
        // Remove tie detection classes
        document.getElementById('playerScore').classList.remove('tie-detected');
        document.getElementById('bankerScore').classList.remove('tie-detected');
        
        // Clear certification state
        awaitingNonNaturalCert = false;
        hideCertificationMessage();
        
        document.getElementById('validationMessage').style.display = 'none';
    }
    
    // ============================================
    // NEW SHOE
    // ============================================
    function startNewShoe() {
        const currentShoeHands = dataCollection.filter(r => r.shoe_number === currentShoeNumber).length;
        
        const proceed = () => {
            currentShoeNumber++;
            document.getElementById('shoeNumber').value = currentShoeNumber;
            
            currentHandNumber = 1;
            document.getElementById('handNumber').value = 1;
            handsInCurrentShoe = 0;
            
            clearForm();
            
            showValidationMessage('Shoe ' + currentShoeNumber + ' started', 'success');
            updateSidebar();
        };

        if (currentShoeHands === 0) {
            openConfirmModal(
                'Empty Shoe',
                'Current shoe has no hands. Are you sure you want to start a new shoe?',
                'Yes, Continue',
                proceed
            );
        } else {
            proceed();
        }
    }
    
    // ============================================
    // HAND NUMBER CHANGE HANDLER
    // ============================================
    function handleHandNumberChange(input) {
        const newValue = parseInt(input.value);
        
        if (!isNaN(newValue) && newValue >= 1) {
            currentHandNumber = newValue;
        }
        // If input is empty or invalid (e.g. "0" or ""), 
        // currentHandNumber retains its last valid value.
        // This prevents an empty/invalid value from breaking
        // the recordHand() or skipHand() functions.
        
        updateSidebar(); // Keep sidebar in sync
    }
    
    // ============================================
    // SIDEBAR UPDATES
    // ============================================
    function updateSidebar() {
        const selectedState = document.querySelector('input[name="state"]:checked').value;
        document.getElementById('sidebarState').textContent = selectedState;
        document.getElementById('sidebarShoe').textContent = currentShoeNumber;
        // Read from state variable for consistency
        document.getElementById('sidebarHand').textContent = currentHandNumber; 
        document.getElementById('sidebarTotal').textContent = dataCollection.length;
        document.getElementById('sidebarShoeCount').textContent = handsInCurrentShoe;
    }
    
    function updateRecentHandsBubbles() {
        const container = document.getElementById('recentHandsContainer');
        
        if (dataCollection.length === 0) {
            container.innerHTML = '<p style="font-size: 11px; color: #999;">None</p>';
            return;
        }
        
        const last3 = dataCollection.slice(-3).reverse();
        
        container.innerHTML = '';
        last3.forEach((record, idx) => {
            const bubble = document.createElement('div');
            bubble.className = 'recent-hand';
            bubble.onclick = () => openEditModal(dataCollection.length - 1 - idx);
            
            const winnerIcon = record.winner === 'player' ? 'P' : record.winner === 'banker' ? 'B' : 'T';
            const naturalIcon = record.natural_win ? '*' : '';
            
            bubble.innerHTML = `
                <div class="recent-hand-header">#${record.hand_number} (S${record.shoe_number})</div>
                <div class="recent-hand-details">${winnerIcon} ${record.player_score}-${record.banker_score}${naturalIcon} | ${record.tStart}s</div>
            `;
            
            container.appendChild(bubble);
        });
    }
    
    // ============================================
    // EDIT MODAL
    // ============================================
    function openEditModal(index) {
        currentEditingIndex = index;
        const record = dataCollection[index];
        
        document.getElementById('editModalTitle').textContent = `Edit #${record.hand_number} (Shoe ${record.shoe_number})`;
        
        document.getElementById('edit_tStart').value = record.tStart;
        document.getElementById('edit_usdPlayer').value = record.usd_player;
        document.getElementById('edit_usdBanker').value = record.usd_banker;
        document.getElementById('edit_usdTie').value = record.usd_tie;
        document.getElementById('edit_nPlayer').value = record.n_player;
        document.getElementById('edit_nBanker').value = record.n_banker;
        document.getElementById('edit_nTie').value = record.n_tie;
        document.getElementById('edit_playerScore').value = record.player_score;
        document.getElementById('edit_bankerScore').value = record.banker_score;
        document.getElementById('edit_naturalWin').checked = record.natural_win;
        document.getElementById('edit_playerPair').checked = record.player_pair;
        document.getElementById('edit_bankerPair').checked = record.banker_pair;
        document.getElementById('edit_playerPerfectPair').checked = record.player_perfect_pair || false;
        document.getElementById('edit_bankerPerfectPair').checked = record.banker_perfect_pair || false;
        
        updateEditPreview();
        
        document.getElementById('editModal').style.display = 'block';
    }
    
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        currentEditingIndex = null;
    }
    
    function updateEditPreview() {
        const data = {
            player_score: parseInt(document.getElementById('edit_playerScore').value) || 0,
            banker_score: parseInt(document.getElementById('edit_bankerScore').value) || 0,
            natural_win: document.getElementById('edit_naturalWin').checked,
            usd_player: parseFloat(document.getElementById('edit_usdPlayer').value) || 0,
            usd_banker: parseFloat(document.getElementById('edit_usdBanker').value) || 0,
            usd_tie: parseFloat(document.getElementById('edit_usdTie').value) || 0,
            player_pair: document.getElementById('edit_playerPair').checked,
            banker_pair: document.getElementById('edit_bankerPair').checked
        };
        
        const metrics = computeDerivedMetrics(data);
        
        document.getElementById('edit_preview_winner').textContent = metrics.winner;
        document.getElementById('edit_preview_majority').textContent = metrics.majority_usd;
        document.getElementById('edit_preview_bonus').textContent = metrics.bonus_bet_payout;
    }
    
    ['edit_playerScore', 'edit_bankerScore', 'edit_naturalWin', 'edit_usdPlayer', 'edit_usdBanker', 'edit_usdTie'].forEach(id => {
        const elem = document.getElementById(id);
        if (elem) {
            elem.addEventListener('input', updateEditPreview);
            elem.addEventListener('change', updateEditPreview);
        }
    });
    
    function saveEdit() {
        const handIndex = currentEditingIndex;
        const original = {...dataCollection[handIndex]};
        
        const edited = {
            ...original,
            tStart: parseInt(document.getElementById('edit_tStart').value),
            usd_player: parseFloat(document.getElementById('edit_usdPlayer').value) || 0,
            usd_banker: parseFloat(document.getElementById('edit_usdBanker').value) || 0,
            usd_tie: parseFloat(document.getElementById('edit_usdTie').value) || 0,
            n_player: parseInt(document.getElementById('edit_nPlayer').value) || 0,
            n_banker: parseInt(document.getElementById('edit_nBanker').value) || 0,
            n_tie: parseInt(document.getElementById('edit_nTie').value) || 0,
            player_score: parseInt(document.getElementById('edit_playerScore').value),
            banker_score: parseInt(document.getElementById('edit_bankerScore').value),
            natural_win: document.getElementById('edit_naturalWin').checked,
            player_pair: document.getElementById('edit_playerPair').checked,
            banker_pair: document.getElementById('edit_bankerPair').checked,
            player_perfect_pair: document.getElementById('edit_playerPerfectPair').checked,
            banker_perfect_pair: document.getElementById('edit_bankerPerfectPair').checked
        };
        
        const computed = computeDerivedMetrics(edited);
        const updated = {...edited, ...computed};
        
        if (!updated.editHistory) updated.editHistory = [];
        updated.editHistory.push({
            timestamp: new Date().toISOString(),
            changes: getChangedFields(original, updated)
        });
        
        dataCollection[handIndex] = updated;
        saveToStorage();
        
        updateRecentHandsBubbles();
        closeEditModal();
        
        showValidationMessage('Hand updated', 'success');
    }
    
    function deleteHand() {
        openConfirmModal(
            'Delete Hand?',
            'Are you sure you want to permanently delete this hand?',
            'Yes, Delete',
            () => {
                dataCollection.splice(currentEditingIndex, 1);
                saveToStorage();
                
                updateRecentHandsBubbles();
                updateSidebar();
                closeEditModal();
                
                showValidationMessage('Hand deleted', 'error');
            }
        );
    }
    
    function getChangedFields(original, updated) {
        const changes = {};
        for (let key in updated) {
            if (original[key] !== updated[key] && !key.startsWith('edit')) {
                changes[key] = {from: original[key], to: updated[key]};
            }
        }
        return changes;
    }
    
    // ============================================
    // CLEAR ALL DATA MODAL
    // ============================================
    function openClearAllModal() {
        document.getElementById('clearAllConfirmCheck').checked = false;
        document.getElementById('clearAllModal').style.display = 'block';
    }
    
    function closeClearAllModal() {
        document.getElementById('clearAllModal').style.display = 'none';
    }
    
    function confirmClearAll() {
        const confirmed = document.getElementById('clearAllConfirmCheck').checked;
        const warning = document.querySelector('.clear-all-modal .clear-all-warning');
        
        if (!confirmed) {
            // Show error message inside the modal
            warning.textContent = 'You must check the confirmation box to proceed.';
            warning.style.color = '#721c24';
            warning.style.background = '#f8d7da';
            warning.style.borderColor = '#f5c6cb';
            return;
        }
        
        // Reset warning message
        warning.textContent = 'This will permanently delete all collected hands. This action cannot be undone!';
        warning.style.color = '#856404';
        warning.style.background = '#fff3cd';
        warning.style.borderColor = '#ffc107';

        openConfirmModal(
            'FINAL WARNING',
            'This will delete all ' + dataCollection.length + ' hands. Are you absolutely sure?',
            'Yes, Delete All',
            () => {
                dataCollection = [];
                currentShoeNumber = 1;
                currentHandNumber = 1;
                currentDealerHandNumber = null;
                handsInCurrentShoe = 0;
                
                document.getElementById('shoeNumber').value = 1;
                document.getElementById('handNumber').value = 1;
                document.getElementById('dealerHandNumber').value = '';
                
                saveToStorage();
                updateSidebar();
                updateRecentHandsBubbles();
                closeClearAllModal(); // Close the 'clear all' modal
                
                showValidationMessage('All data cleared', 'error');
            }
        );
    }
    
    // ============================================
    // STORAGE
    // ============================================
    function saveToStorage() {
        try {
            localStorage.setItem('baccaratData', JSON.stringify(dataCollection));
            localStorage.setItem('baccaratMeta', JSON.stringify({
                currentShoeNumber,
                currentHandNumber,
                currentDealerHandNumber,
                handsInCurrentShoe
            }));
        } catch (e) {
            console.error('Failed to save to localStorage:', e);
        }
    }
    
    function loadFromStorage() {
        try {
            const savedData = localStorage.getItem('baccaratData');
            const savedMeta = localStorage.getItem('baccaratMeta');
            
            if (savedData) {
                dataCollection = JSON.parse(savedData);
            }
            
            if (savedMeta) {
                const meta = JSON.parse(savedMeta);
                currentShoeNumber = meta.currentShoeNumber || 1;
                currentHandNumber = meta.currentHandNumber || 1;
                currentDealerHandNumber = meta.currentDealerHandNumber || null;
                handsInCurrentShoe = meta.handsInCurrentShoe || 0;
                
                document.getElementById('shoeNumber').value = currentShoeNumber;
                document.getElementById('handNumber').value = currentHandNumber;
                if (currentDealerHandNumber !== null) {
                    document.getElementById('dealerHandNumber').value = currentDealerHandNumber;
                }
            }
        } catch (e) {
            console.error('Failed to load from localStorage:', e);
        }
    }
    
    // ============================================
    // EXPORT
    // ============================================
    function exportCSV() {
        if (dataCollection.length === 0) {
            showValidationMessage('No data to export', 'error');
            return;
        }
        
        const headers = [
            'state', 'shoe_number', 'hand_number', 'dealer_hand_number', 'dealer_change',
            'tStart', 'usd_player', 'usd_banker', 'usd_tie', 'n_player', 'n_banker', 'n_tie',
            'player_score', 'banker_score', 'player_pair', 'banker_pair', 
            'player_perfect_pair', 'banker_perfect_pair',
            'natural_win', 'winner', 'majority_usd', 'majority_count',
            'majority_usd_correct', 'majority_count_correct', 'bonus_bet_payout', 'timestamp'
        ];
        
        let csv = headers.join(',') + '\n';
        
        dataCollection.forEach(row => {
            const values = headers.map(h => {
                let val = row[h];
                if (val === null || val === undefined) val = '';
                if (typeof val === 'boolean') val = val ? 1 : 0;
                return val;
            });
            csv += values.join(',') + '\n';
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'baccarat_data_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        window.URL.revokeObjectURL(url);
        
        showValidationMessage('CSV exported', 'success');
    }
    
    function exportJSON() {
        if (dataCollection.length === 0) {
            showValidationMessage('No data to export', 'error');
            return;
        }
        
        const json = JSON.stringify(dataCollection, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'baccarat_data_' + new Date().toISOString().split('T')[0] + '.json';
        a.click();
        window.URL.revokeObjectURL(url);
        
        showValidationMessage('JSON exported', 'success');
    }
    
    // ============================================
    // GENERIC CONFIRMATION MODAL
    // ============================================
    function openConfirmModal(title, body, yesText, yesCallback) {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalBody').innerHTML = body; // Use innerHTML for simple formatting
        document.getElementById('confirmModalYesBtn').textContent = yesText;
        
        // Remove old listener and add new one to prevent stacking
        const yesBtn = document.getElementById('confirmModalYesBtn');
        const newYesBtn = yesBtn.cloneNode(true);
        yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
        
        newYesBtn.addEventListener('click', () => {
            if (yesCallback) {
                yesCallback();
            }
            closeConfirmModal();
        });
        
        document.getElementById('confirmModal').style.display = 'block';
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }
</script>
</body> </html>
